<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.Cinema_Management_System.Arrangement.dao.ArrangementDao"><!--namespace:定义一个操作包  -->
    <select id="getArrange" resultType="com.Cinema_Management_System.Arrangement.entity.Arrangement">
        select *
        from Cinema_arrangement
        where arrangement_id = #{arrangementId}
    </select>
<!--查询排场-->
    <select id="getArranges" resultType="com.Cinema_Management_System.Arrangement.entity.Arrangement">
        select a.*,m.movie_name
        from Cinema_arrangement a left join Cinema_movie m on a.movie_id = m.movie_id

        <where>
            <if test="1 == 1">
                a.arrangement_time &gt; now()
            </if>
            <if test="selContent !=null and selContent != ''">
                <if test="selType == 'movieId'">
                    and a.movie_id = #{selContent}
                </if>
                <if test="selType == 'movieName'">
                    and m.movie_name like CONCAT(CONCAT('%',#{selContent}),'%')
                </if>
                <if test="selType == 'arrangementId'">
                    and a.arrangement_id = #{selContent}
                </if>
                <if test="selType == 'arrangementPlace'">
                    and a.arrangement_place = #{selContent}
                </if>
            </if>
        </where>

        limit #{pageStart},#{pageSize}
    </select>
<!--查询数量-->
    <select id="getCount" resultType="int">
        select count(*)
        from Cinema_arrangement a left join Cinema_movie m on a.movie_id = m.movie_id
        <where>
            <if test="1 == 1">
                arrangement_time &gt; now()
            </if>
            <if test="selContent !=null and selContent != ''">
                <if test="selType == 'movieId'">
                    and a.movie_id = #{selContent}
                </if>
                <if test="selType == 'movieName'">
                    and m.movie_name like CONCAT(CONCAT('%',#{selContent}),'%')
                </if>
                <if test="selType == 'arrangementId'">
                    and a.arrangement_id = #{selContent}
                </if>
                <if test="selType == 'arrangementPlace'">
                    and a.arrangement_place = #{selContent}
                </if>
            </if>
        </where>
    </select>

    <select id="getMovieTime" resultType="string">
       select movie_time from Cinema_movie
       where movie_id = #{movieId};
    </select>

    <select id="getDisableTime" resultType="com.Cinema_Management_System.Arrangement.entity.UsedTime">
        SELECT
        a.arrangement_time,m.movie_time
        FROM
        Cinema_arrangement a,Cinema_movie m
        WHERE
        arrangement_time &gt; #{dayStart} AND arrangement_time &lt; #{dayEnd} AND a.movie_id = m.movie_id AND a.arrangement_place = #{arrangementPlace}
        order by a.arrangement_time
    </select>

    <select id="getArrangeMovie" resultType="com.Cinema_Management_System.Movie.entity.ArrangementMovie">
        select movie_id,movie_name,movie_picture,movie_score,movie_actor,movie_time,movie_type
        from Cinema_movie
        where movie_id = #{movieId}
    </select>

    <select id="getNowArranges" resultType="com.Cinema_Management_System.Arrangement.entity.Arrangement">
        select a.*,m.movie_time
        from Cinema_arrangement a left join Cinema_movie m on a.movie_id = m.movie_id
        where a.arrangement_time &gt; now() and a.movie_id = #{movieId}
        order by a.arrangement_time
    </select>

    <select id="getMovieInfo" resultType="com.Cinema_Management_System.Movie.entity.ArrangementMovie">
        select movie_id,movie_time,movie_name,movie_picture,movie_type
        from Cinema_movie
        where movie_id = (select movie_id from Cinema_arrangement where arrangement_id = #{arrangementId})
    </select>

    <select id="getSelectedSeats" resultType="string">
        select seat_num
        from Cinema_seat
        where arrangement_id = #{arrangementId}
    </select>

<!--添加电影-->
    <insert id="addArrangement" parameterType="com.Cinema_Management_System.Arrangement.entity.Arrangement">
        insert into Cinema_arrangement
        value (#{arrangementId},#{arrangementTime},#{arrangementPlace},#{arrangementPrice},#{movieId})
    </insert>

<!--删除一个-->
    <delete id="deleteArrangement" parameterType="int">
        delete from Cinema_arrangement
        where arrangement_id = #{arrangementId}
    </delete>
<!--批量删除-->
    <delete id="deleteArrangements" parameterType="list">
        delete from Cinema_arrangement where arrangement_id in
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">#{item}</foreach>
    </delete>

<!--更新排场-->
    <update id="updateArrangement" parameterType="com.Cinema_Management_System.Arrangement.entity.Arrangement">
        update Cinema_arrangement
        set movie_id = #{movieId},arrangement_time = #{arrangementTime},
        arrangement_price = #{arrangementPrice},arrangement_place = #{arrangementPlace}
        where arrangement_id = #{arrangementId}
    </update>

<!--查看是否有订单-->
    <select id="selectArrangementCountList" resultType="int">
        SELECT COUNT(*) FROM  cinema_order o
        WHERE o.arrangement_id in
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">#{item}</foreach>
    </select>
    <select id="selectArrangementCountSingle" resultType="int">
        SELECT COUNT(*) FROM  cinema_order o
        WHERE o.arrangement_id=#{id}
    </select>

</mapper>