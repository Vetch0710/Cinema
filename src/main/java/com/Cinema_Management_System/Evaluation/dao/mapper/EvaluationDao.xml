<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.Cinema_Management_System.Evaluation.dao.EvaluationDao"><!--namespace:定义一个操作包  -->

    <select id="getCount" resultType="int">
        select count(*)
        FROM Cinema_evaluation e
        LEFT JOIN (
        SELECT o.order_id,o.movie_id,o.customer_id,m.movie_name,c.customer_name
        FROM Cinema_order o,Cinema_customer c,Cinema_movie m
        WHERE
        o.customer_id = c.customer_id AND o.movie_id = m.movie_id
        ) AS w ON w.order_id = e.order_id
        <where>
            <if test="1==1">
                e.evaluation_time is not null
            </if>
            <if test="selContent != null and selContent != ''">
                <if test="selType == 'movieId'">
                    and w.movie_id = #{selContent}
                </if>
                <if test="selType == 'movieName'">
                    and w.movie_name like CONCAT(CONCAT('%',#{selContent}),'%')
                </if>
                <if test="selType == 'evaluationId'">
                    and e.evaluation_id = #{selContent}
                </if>
                <if test="selType == 'customerId'">
                    and w.customer_id = #{selContent}
                </if>
            </if>
        </where>
    </select>

    <select id="getEvaluations" resultType="com.Cinema_Management_System.Evaluation.entity.Evaluation">
        SELECT
        e.evaluation_id,e.evaluation_content,e.evaluation_score,e.evaluation_time,w.customer_name,w.movie_name
        FROM
        Cinema_evaluation e
        LEFT JOIN (
        SELECT o.order_id,o.movie_id,o.customer_id,m.movie_name,c.customer_name
        FROM Cinema_order o,Cinema_customer c,Cinema_movie m
        WHERE
        o.customer_id = c.customer_id AND o.movie_id = m.movie_id
        ) AS w ON w.order_id = e.order_id
        <where>
            <if test="1==1">
                e.evaluation_time is not null
            </if>
            <if test="selContent != null and selContent != ''">
                <if test="selType == 'movieId'">
                    and w.movie_id = #{selContent}
                </if>
                <if test="selType == 'movieName'">
                    and w.movie_name like CONCAT(CONCAT('%',#{selContent}),'%')
                </if>
                <if test="selType == 'evaluationId'">
                    and e.evaluation_id = #{selContent}
                </if>
                <if test="selType == 'customerId'">
                    and w.customer_id = #{selContent}
                </if>
            </if>
        </where>
        limit #{pageStart},#{pageSize}
    </select>

    <select id="getMovieEvaluation" resultType="com.Cinema_Management_System.Evaluation.entity.Evaluation">
        select e.evaluation_id,e.evaluation_score,e.evaluation_content,e.evaluation_time,w.customer_name,w.customer_picture
        from Cinema_evaluation e
        LEFT JOIN (
        SELECT o.order_id,o.movie_id,o.customer_id,m.movie_name,c.customer_name,c.customer_picture
        FROM Cinema_order o,Cinema_customer c,Cinema_movie m
        WHERE
        o.customer_id = c.customer_id AND o.movie_id = m.movie_id
        ) AS w ON w.order_id = e.order_id
        where w.movie_id = #{movieId}
        limit #{pageStart},#{pageSize}
    </select>
    <select id="getMovieEvaluationCount" resultType="int">
        select count(*)
        from Cinema_evaluation e
        LEFT JOIN (
        SELECT o.order_id,o.movie_id,o.customer_id,m.movie_name,c.customer_name,c.customer_picture
        FROM Cinema_order o,Cinema_customer c,Cinema_movie m
        WHERE
        o.customer_id = c.customer_id AND o.movie_id = m.movie_id
        ) AS w ON w.order_id = e.order_id
        where w.movie_id = #{movieId}
    </select>
</mapper>